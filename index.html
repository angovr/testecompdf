<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizar PDF</title>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        #pdf-container {
            width: 100%;
            height: calc(100vh - 50px); /* Ajusta o tamanho para permitir o botão */
            border: none;
            overflow: hidden;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        #save-button {
            width: 100%;
            height: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
        }
        #save-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <!-- Contêiner para exibir o PDF em um iframe -->
    <div id="pdf-container">
        <iframe id="pdf-iframe" src="https://angovr.github.io/testecompdf/formulario.pdf" frameborder="0"></iframe>
    </div>

    <!-- Botão para salvar o PDF -->
    <button id="save-button">Salvar PDF</button>

    <script>
        document.getElementById("save-button").addEventListener("click", async function () {
            try {
                const { PDFDocument } = PDFLib;

                // URL do PDF original (o mesmo carregado no iframe)
                const url = "https://angovr.github.io/testecompdf/formulario.pdf"; 
                const existingPdfBytes = await fetch(url).then((res) => res.arrayBuffer());

                // Carregar o PDF
                const pdfDoc = await PDFDocument.load(existingPdfBytes);
                const form = pdfDoc.getForm();

                // Obter dados dinâmicos (por exemplo, o nome do responsável)
                const nomeResponsavel = "João da Silva"; // Exemplo: Substituir por valor dinâmico se necessário

                // (Opcional) Preencher campos no formulário, se aplicável
                const nomeField = form.getTextField("nome");
                nomeField.setText(nomeResponsavel);

                // Obter a data atual no formato "YYYY-MM-DD"
                const today = new Date();
                const dataAtual = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}-${String(today.getDate()).padStart(2, "0")}`;

                // Gerar o nome do arquivo
                const nomeArquivo = `Formulario_${nomeResponsavel.replace(/ /g, "_")}_${dataAtual}.pdf`;

                // Salvar o PDF preenchido
                const pdfBytes = await pdfDoc.save();

                // Criar link para download do PDF
                const link = document.createElement("a");
                link.href = URL.createObjectURL(new Blob([pdfBytes], { type: "application/pdf" }));
                link.download = nomeArquivo;
                link.click();

                // Revogar o objeto URL
                URL.revokeObjectURL(link.href);
            } catch (error) {
                console.error("Erro ao salvar o PDF:", error);
                alert("Erro ao salvar o PDF.");
            }
        });
    </script>
</body>
</html>
